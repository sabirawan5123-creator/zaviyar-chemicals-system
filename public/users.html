<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users - Zaviyar Chemicals</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e8edf2 100%); min-height: 100vh; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); padding: 24px 40px; box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; animation: fadeIn 0.5s ease-out; }
        .header h1 { color: white; font-size: 28px; font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: center; gap: 12px; }
        .header h1::before { content: 'ðŸ‘¤'; font-size: 32px; }
        .header-actions { display: flex; gap: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .container { padding: 0 30px 30px; max-width: 1400px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .search-bar { margin-bottom: 20px; display: flex; gap: 15px; }
        .search-bar input, .search-bar select { padding: 12px 16px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .search-bar input { flex: 1; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; }
        th { padding: 12px; text-align: left; font-size: 12px; font-weight: 700; text-transform: uppercase; color: #6b7280; border-bottom: 2px solid #e5e7eb; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; color: #1f2937; }
        tr:hover { background: #f9fafb; }
        .badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-admin { background: #fecaca; color: #991b1b; }
        .badge-accountant { background: #bfdbfe; color: #1e3a8a; }
        .badge-viewer { background: #d1fae5; color: #065f46; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #1f2937; font-size: 20px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 12px 16px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px; color: #1f2937; font-weight: 600; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        .empty-state { text-align: center; padding: 60px 20px; color: #6b7280; }
        .info-box { background: #eff6ff; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        
        /* RESPONSIVE DESIGN */
        @media (max-width: 1024px) { .modal-content { max-width: 700px; padding: 25px; } .form-row { gap: 12px; } }
        @media (max-width: 768px) { .modal-content { max-width: 95%; width: 95%; padding: 20px; margin: 10px; max-height: 90vh; } .modal-header h2 { font-size: 18px; } .close-btn { font-size: 28px; } .form-row { grid-template-columns: 1fr; gap: 10px; } .form-group { margin-bottom: 16px; } .form-group label { font-size: 13px; margin-bottom: 6px; } .form-group input, .form-group select, .form-group textarea { padding: 10px 14px; font-size: 14px; } .btn { padding: 12px 18px; font-size: 13px; } .header { padding: 18px 20px; flex-direction: column; gap: 12px; align-items: flex-start; } .header h1 { font-size: 22px; } .header-actions { width: 100%; flex-direction: column; gap: 10px; } .header-actions .btn { width: 100%; } .container { padding: 0 15px 15px; } }
        @media (max-width: 480px) { .modal-content { width: 100%; height: 100%; max-height: 100vh; max-width: 100%; border-radius: 0; padding: 15px; margin: 0; } .modal-header { margin-bottom: 15px; padding-bottom: 12px; border-bottom: 2px solid #e5e7eb; } .modal-header h2 { font-size: 16px; } .close-btn { font-size: 32px; padding: 0; min-width: 32px; } .form-group { margin-bottom: 14px; } .form-group label { font-size: 12px; margin-bottom: 6px; } .form-group input, .form-group select, .form-group textarea { padding: 10px 12px; font-size: 13px; } .btn { padding: 10px 16px; font-size: 13px; } .header { padding: 15px; } .header h1 { font-size: 18px; } .header h1::before { font-size: 24px; } .container { padding: 0 10px 10px; } .card { padding: 15px; border-radius: 8px; } table { font-size: 12px; } th, td { padding: 8px 6px; } th { font-size: 10px; } }
        @media (max-width: 360px) { .modal-content { padding: 12px; } .modal-header h2 { font-size: 15px; } .form-group label { font-size: 11px; } .form-group input, .form-group select, .form-group textarea { padding: 8px 10px; font-size: 12px; } .btn { padding: 8px 14px; font-size: 12px; } .header h1 { font-size: 16px; } table { font-size: 11px; } th, td { padding: 6px 4px; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>User Management</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="window.location.href='/dashboard.html'">Back to Dashboard</button>
            <button class="btn btn-primary" onclick="openAddModal()">+ Add User</button>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search users by name or email..." onkeyup="searchUsers()">
                <select id="roleFilter" onchange="searchUsers()">
                    <option value="">All Roles</option>
                    <option value="admin">Admin</option>
                    <option value="accountant">Accountant</option>
                    <option value="viewer">Viewer</option>
                </select>
            </div>

            <div id="usersList">
                <div class="loading">Loading users...</div>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add User</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="info-box">
                <strong>Roles:</strong><br>
                â€¢ Admin: Full access to all modules<br>
                â€¢ Accountant: Manage sales, purchases, expenses, payments<br>
                â€¢ Viewer: Read-only access
            </div>

            <form id="userForm" onsubmit="saveUser(event)">
                <input type="hidden" id="userId">
                
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="userName" required>
                </div>

                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="userEmail" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Password <span id="passwordRequired">*</span></label>
                        <input type="password" id="userPassword" minlength="6">
                        <small style="color: #6b7280;" id="passwordHint">Min 6 characters</small>
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <select id="userRole" required>
                            <option value="">Select Role</option>
                            <option value="admin">Admin</option>
                            <option value="accountant">Accountant</option>
                            <option value="viewer">Viewer</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-success" id="saveBtn">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!token) window.location.href = '/login.html';
        if (currentUser.role !== 'admin') {
            alert('Access denied. Admin only.');
            window.location.href = '/dashboard.html';
        }

        let users = [];
        loadUsers();

        async function loadUsers() {
            try {
                const response = await fetch('/api/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to load users');
                const result = await response.json();
                users = result.data || [];
                displayUsers(users);
            } catch (error) {
                document.getElementById('usersList').innerHTML = '<div class="error">Failed to load users</div>';
            }
        }

        function displayUsers(usersToShow) {
            const container = document.getElementById('usersList');
            if (usersToShow.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No users found</h3></div>';
                return;
            }

            let html = '<table><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
            usersToShow.forEach(user => {
                const badgeClass = user.role === 'admin' ? 'admin' : user.role === 'accountant' ? 'accountant' : 'viewer';
                const date = new Date(user.createdAt).toLocaleDateString();
                const isCurrentUser = user.id === currentUser.id;
                
                html += `<tr>
                    <td><strong>${user.name}</strong>${isCurrentUser ? ' <span style="color:#3b82f6;">(You)</span>' : ''}</td>
                    <td>${user.email}</td>
                    <td><span class="badge badge-${badgeClass}">${user.role.toUpperCase()}</span></td>
                    <td>${date}</td>
                    <td>
                        <button class="btn btn-primary" onclick='editUser(${JSON.stringify(user)})' style="margin-right: 10px; padding: 8px 16px;">Edit</button>
                        ${!isCurrentUser ? `<button class="btn btn-danger" onclick="deleteUser(${user.id})" style="padding: 8px 16px;">Delete</button>` : ''}
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const role = document.getElementById('roleFilter').value;

            let filtered = users.filter(user => {
                const matchesSearch = user.name.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm);
                const matchesRole = !role || user.role === role;
                return matchesSearch && matchesRole;
            });
            displayUsers(filtered);
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userPassword').required = true;
            document.getElementById('passwordRequired').style.display = 'inline';
            document.getElementById('passwordHint').textContent = 'Min 6 characters';
            document.getElementById('userModal').classList.add('active');
        }

        function editUser(user) {
            document.getElementById('modalTitle').textContent = 'Edit User';
            document.getElementById('userId').value = user.id;
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = false;
            document.getElementById('passwordRequired').style.display = 'none';
            document.getElementById('passwordHint').textContent = 'Leave blank to keep current password';
            document.getElementById('userModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        async function saveUser(event) {
            event.preventDefault();
            
            const userId = document.getElementById('userId').value;
            const isEdit = userId !== '';
            
            const data = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value
            };

            const password = document.getElementById('userPassword').value;
            if (password) {
                data.password = password;
            }

            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const url = isEdit ? `/api/users/${userId}` : '/api/auth/register';
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save user');
                }
                
                closeModal();
                loadUsers();
                alert(isEdit ? 'User updated successfully!' : 'User created successfully!');
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save User';
            }
        }

        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            try {
                const response = await fetch(`/api/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to delete user');
                
                loadUsers();
                alert('User deleted successfully!');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    </script>
</body>
</html>

