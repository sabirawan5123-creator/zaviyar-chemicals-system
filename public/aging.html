<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Aging - Zaviyar Chemicals</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e8edf2 100%); min-height: 100vh; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 24px 40px; box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; animation: fadeIn 0.5s ease-out; }
        .header h1 { color: white; font-size: 28px; font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: center; gap: 12px; }
        .header h1::before { content: 'ðŸ“Š'; font-size: 32px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-primary { background: #3b82f6; color: white; }
        .container { padding: 0 30px 30px; max-width: 1400px; margin: 0 auto; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .tab.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: #f9fafb; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6; }
        .summary-card h3 { color: #6b7280; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; }
        .summary-card p { color: #1f2937; font-size: 24px; font-weight: 700; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; }
        th { padding: 12px; text-align: left; font-size: 12px; font-weight: 700; text-transform: uppercase; color: #6b7280; border-bottom: 2px solid #e5e7eb; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; color: #1f2937; }
        tr:hover { background: #f9fafb; }
        tr.overdue { background: #fee2e2; }
        tr.due-soon { background: #fef3c7; }
        .badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        .empty-state { text-align: center; padding: 60px 20px; color: #6b7280; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Bill Aging Report</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="window.location.href='/dashboard.html'">Back to Dashboard</button>
            <button class="btn btn-primary" onclick="exportReport()">Export to CSV</button>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('sales')">Sales Aging</div>
            <div class="tab" onclick="switchTab('purchases')">Purchase Aging</div>
        </div>

        <!-- Sales Aging -->
        <div id="salesTab">
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Total Outstanding</h3>
                    <p id="salesTotal">$0.00</p>
                </div>
                <div class="summary-card" style="border-left-color: #ef4444;">
                    <h3>Overdue Bills</h3>
                    <p id="salesOverdue" style="color: #ef4444;">0</p>
                </div>
                <div class="summary-card" style="border-left-color: #f59e0b;">
                    <h3>Due This Week</h3>
                    <p id="salesDueSoon" style="color: #f59e0b;">0</p>
                </div>
            </div>

            <div class="card">
                <div id="salesList">
                    <div class="loading">Loading sales aging...</div>
                </div>
            </div>
        </div>

        <!-- Purchase Aging -->
        <div id="purchasesTab" style="display: none;">
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Total Outstanding</h3>
                    <p id="purchasesTotal">$0.00</p>
                </div>
                <div class="summary-card" style="border-left-color: #ef4444;">
                    <h3>Overdue Bills</h3>
                    <p id="purchasesOverdue" style="color: #ef4444;">0</p>
                </div>
                <div class="summary-card" style="border-left-color: #f59e0b;">
                    <h3>Due This Week</h3>
                    <p id="purchasesDueSoon" style="color: #f59e0b;">0</p>
                </div>
            </div>

            <div class="card">
                <div id="purchasesList">
                    <div class="loading">Loading purchase aging...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';

        let salesData = [];
        let purchasesData = [];
        let customers = [];
        let suppliers = [];
        let currentTab = 'sales';

        init();

        async function init() {
            await Promise.all([
                loadCustomers(),
                loadSuppliers(),
                loadSales(),
                loadPurchases()
            ]);
            calculateAging('sales');
        }

        async function loadCustomers() {
            try {
                const response = await fetch('/api/contacts?type=customer', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                customers = result.data || [];
            } catch (error) {
                console.error('Failed to load customers');
            }
        }

        async function loadSuppliers() {
            try {
                const response = await fetch('/api/contacts?type=supplier', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                suppliers = result.data || [];
            } catch (error) {
                console.error('Failed to load suppliers');
            }
        }

        async function loadSales() {
            try {
                const response = await fetch('/api/sales', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                salesData = (result.data || []).filter(s => s.paymentStatus === 'pending' || s.paymentStatus === 'partial');
            } catch (error) {
                console.error('Failed to load sales');
            }
        }

        async function loadPurchases() {
            try {
                const response = await fetch('/api/purchases', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                purchasesData = (result.data || []).filter(p => p.paymentStatus === 'pending' || p.paymentStatus === 'partial');
            } catch (error) {
                console.error('Failed to load purchases');
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'sales') {
                document.getElementById('salesTab').style.display = 'block';
                document.getElementById('purchasesTab').style.display = 'none';
                calculateAging('sales');
            } else {
                document.getElementById('salesTab').style.display = 'none';
                document.getElementById('purchasesTab').style.display = 'block';
                calculateAging('purchases');
            }
        }

        function calculateAging(type) {
            const data = type === 'sales' ? salesData : purchasesData;
            const contacts = type === 'sales' ? customers : suppliers;
            const today = new Date();
            
            const agingData = data.map(item => {
                const invoiceDate = new Date(item.createdAt);
                const daysOld = Math.floor((today - invoiceDate) / (1000 * 60 * 60 * 24));
                const contact = contacts.find(c => c.id === (type === 'sales' ? item.customerId : item.supplierId)) || {name: 'Unknown'};
                
                let status = 'current';
                if (daysOld > 30) status = 'overdue';
                else if (daysOld > 23) status = 'due-soon';
                
                return {
                    ...item,
                    contactName: contact.name,
                    daysOld,
                    status
                };
            });

            // Calculate summary
            const total = agingData.reduce((sum, item) => sum + item.total, 0);
            const overdue = agingData.filter(item => item.status === 'overdue').length;
            const dueSoon = agingData.filter(item => item.status === 'due-soon').length;

            // Update summary cards
            document.getElementById(`${type}Total`).textContent = `$${total.toFixed(2)}`;
            document.getElementById(`${type}Overdue`).textContent = overdue;
            document.getElementById(`${type}DueSoon`).textContent = dueSoon;

            // Display table
            displayAging(agingData, type);
        }

        function displayAging(data, type) {
            const container = document.getElementById(`${type}List`);
            
            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No outstanding bills</h3><p>All bills are paid!</p></div>';
                return;
            }

            const numberLabel = type === 'sales' ? 'Invoice No' : 'PO Number';
            const partyLabel = type === 'sales' ? 'Customer' : 'Supplier';

            let html = `<table><thead><tr>
                <th>${numberLabel}</th>
                <th>${partyLabel}</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Days Old</th>
                <th>Status</th>
            </tr></thead><tbody>`;

            data.sort((a, b) => b.daysOld - a.daysOld).forEach(item => {
                const date = new Date(item.createdAt).toLocaleDateString();
                const statusBadge = item.status === 'overdue' ? 'danger' : item.status === 'due-soon' ? 'warning' : 'success';
                const statusLabel = item.status === 'overdue' ? 'OVERDUE' : item.status === 'due-soon' ? 'DUE SOON' : 'CURRENT';
                const rowClass = item.status === 'overdue' ? 'overdue' : item.status === 'due-soon' ? 'due-soon' : '';

                html += `<tr class="${rowClass}">
                    <td><strong>${type === 'sales' ? item.invoiceNo : item.purchaseNo}</strong></td>
                    <td>${item.contactName}</td>
                    <td>${date}</td>
                    <td><strong>$${item.total.toFixed(2)}</strong></td>
                    <td><strong>${item.daysOld}</strong> days</td>
                    <td><span class="badge badge-${statusBadge}">${statusLabel}</span></td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function exportReport() {
            const data = currentTab === 'sales' ? salesData : purchasesData;
            const contacts = currentTab === 'sales' ? customers : suppliers;
            
            if (data.length === 0) {
                alert('No data to export');
                return;
            }

            const today = new Date();
            const csvData = data.map(item => {
                const invoiceDate = new Date(item.createdAt);
                const daysOld = Math.floor((today - invoiceDate) / (1000 * 60 * 60 * 24));
                const contact = contacts.find(c => c.id === (currentTab === 'sales' ? item.customerId : item.supplierId)) || {name: 'Unknown'};
                
                return {
                    Number: currentTab === 'sales' ? item.invoiceNo : item.purchaseNo,
                    Party: contact.name,
                    Date: invoiceDate.toLocaleDateString(),
                    Amount: item.total.toFixed(2),
                    DaysOld: daysOld,
                    Status: item.paymentStatus
                };
            });

            const headers = Object.keys(csvData[0]);
            const csv = [
                headers.join(','),
                ...csvData.map(row => headers.map(h => JSON.stringify(row[h])).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentTab}_aging_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            alert('Report exported successfully!');
        }
    </script>
</body>
</html>

