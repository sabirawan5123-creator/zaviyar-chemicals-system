<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Zaviyar Chemicals</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e8edf2 100%); min-height: 100vh; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); padding: 24px 40px; box-shadow: 0 4px 20px rgba(236, 72, 153, 0.3); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; animation: fadeIn 0.5s ease-out; }
        .header h1 { color: white; font-size: 28px; font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: center; gap: 12px; }
        .header h1::before { content: 'üìà'; font-size: 32px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .container { padding: 0 30px 30px; max-width: 1400px; margin: 0 auto; }
        .reports-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .report-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s; cursor: pointer; }
        .report-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .report-card h3 { color: #1f2937; margin-bottom: 10px; font-size: 18px; }
        .report-card p { color: #6b7280; font-size: 14px; margin-bottom: 15px; }
        .report-card .icon { font-size: 32px; margin-bottom: 15px; }
        .card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card h2 { color: #1f2937; margin-bottom: 20px; font-size: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; align-items: end; }
        .form-group label { display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 12px 16px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .report-output { margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        thead { background: #f9fafb; }
        th { padding: 12px; text-align: left; font-size: 12px; font-weight: 700; text-transform: uppercase; color: #6b7280; border-bottom: 2px solid #e5e7eb; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; color: #1f2937; }
        tr:hover { background: #f9fafb; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        .summary-row { background: #f9fafb; font-weight: 700; }
        .print-header { display: none; }
        @media print {
            .header, .form-row, .btn, .reports-grid { display: none !important; }
            .print-header { display: block; text-align: center; margin-bottom: 30px; }
            body { background: white; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Reports & Analytics</h1>
        <button class="btn btn-secondary" onclick="window.location.href='/dashboard.html'">Back to Dashboard</button>
    </div>

    <div class="container">
        <div class="reports-grid">
            <div class="report-card" onclick="loadReport('sales')">
                <div class="icon">üìä</div>
                <h3>Sales Report</h3>
                <p>View all sales transactions with filters by date and customer</p>
            </div>

            <div class="report-card" onclick="loadReport('purchase')">
                <div class="icon">üõí</div>
                <h3>Purchase Report</h3>
                <p>Complete purchase history with supplier details</p>
            </div>

            <div class="report-card" onclick="loadReport('stock')">
                <div class="icon">üì¶</div>
                <h3>Stock Report</h3>
                <p>Current inventory levels and stock valuation</p>
            </div>

            <div class="report-card" onclick="loadReport('profit-loss')">
                <div class="icon">üí∞</div>
                <h3>Profit & Loss</h3>
                <p>Income statement showing revenue and expenses</p>
            </div>

            <div class="report-card" onclick="loadReport('expense')">
                <div class="icon">üí≥</div>
                <h3>Expense Report</h3>
                <p>All expenses categorized by type and period</p>
            </div>

            <div class="report-card" onclick="loadReport('product-sales')">
                <div class="icon">üìà</div>
                <h3>Product-wise Sales</h3>
                <p>Sales analysis by individual products</p>
            </div>

            <div class="report-card" onclick="loadReport('payables-receivables')">
                <div class="icon">üíµ</div>
                <h3>Payables & Receivables</h3>
                <p>Outstanding amounts to pay and receive</p>
            </div>

            <div class="report-card" onclick="loadReport('cash-flow')">
                <div class="icon">üí∏</div>
                <h3>Cash Flow Report</h3>
                <p>Money in and out of the business</p>
            </div>

            <div class="report-card" onclick="loadReport('balance-sheet')">
                <div class="icon">‚öñÔ∏è</div>
                <h3>Balance Sheet</h3>
                <p>Assets, liabilities, and equity summary</p>
            </div>

            <div class="report-card" onclick="loadReport('customer-sales')">
                <div class="icon">üë•</div>
                <h3>Customer-wise Sales</h3>
                <p>Sales breakdown by customer</p>
            </div>

            <div class="report-card" onclick="loadReport('cash-report')">
                <div class="icon">üíµ</div>
                <h3>Cash Report</h3>
                <p>Cash transactions and balance</p>
            </div>

            <div class="report-card" onclick="loadReport('bank-report')">
                <div class="icon">üè¶</div>
                <h3>Bank Account Report</h3>
                <p>All bank accounts and balances</p>
            </div>
        </div>

        <div id="reportViewer" style="display: none;">
            <div class="card">
                <div class="print-header">
                    <h1>Zaviyar Chemicals</h1>
                    <h2 id="printReportTitle"></h2>
                    <p id="printReportDate"></p>
                </div>

                <h2 id="reportTitle"></h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>From Date</label>
                        <input type="date" id="fromDate">
                    </div>
                    <div class="form-group">
                        <label>To Date</label>
                        <input type="date" id="toDate">
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="generateReport()">Generate</button>
                        <button class="btn btn-success" onclick="exportToCSV()">Export CSV</button>
                        <button class="btn btn-secondary" onclick="window.print()">Print PDF</button>
                    </div>
                </div>

                <div id="reportOutput" class="report-output">
                    <div class="loading">Click Generate to view report</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';

        let currentReport = '';
        let reportData = [];

        function loadReport(type) {
            currentReport = type;
            document.getElementById('reportViewer').style.display = 'block';
            document.querySelector('.reports-grid').style.display = 'none';
            
            const titles = {
                'sales': 'Sales Report',
                'purchase': 'Purchase Report',
                'stock': 'Stock Report',
                'profit-loss': 'Profit & Loss Statement',
                'expense': 'Expense Report',
                'product-sales': 'Product-wise Sales Report',
                'payables-receivables': 'Payables & Receivables Report',
                'cash-flow': 'Cash Flow Report',
                'balance-sheet': 'Balance Sheet',
                'customer-sales': 'Customer-wise Sales Report',
                'cash-report': 'Cash Report',
                'bank-report': 'Bank Account Report'
            };
            
            document.getElementById('reportTitle').textContent = titles[type];
            document.getElementById('printReportTitle').textContent = titles[type];
            document.getElementById('reportOutput').innerHTML = '<div class="loading">Click Generate to view report</div>';
            
            // Set default dates (last 30 days)
            const today = new Date();
            const lastMonth = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            document.getElementById('toDate').value = today.toISOString().split('T')[0];
            document.getElementById('fromDate').value = lastMonth.toISOString().split('T')[0];
        }

        async function generateReport() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            
            document.getElementById('reportOutput').innerHTML = '<div class="loading">Generating report...</div>';
            document.getElementById('printReportDate').textContent = `Period: ${fromDate} to ${toDate}`;

            try {
                // Fixed: Added underscore after 'generate'
                await window[`generate_${currentReport.replace(/-/g, '_')}_report`](fromDate, toDate);
            } catch (error) {
                console.error('Report generation error:', error);
                document.getElementById('reportOutput').innerHTML = `<div class="error">Failed to generate report: ${error.message}</div>`;
            }
        }

        async function generate_sales_report(fromDate, toDate) {
            const response = await fetch('/api/sales', { headers: { 'Authorization': `Bearer ${token}` } });
            const result = await response.json();
            let sales = result.data || [];
            
            if (fromDate) sales = sales.filter(s => new Date(s.createdAt) >= new Date(fromDate));
            if (toDate) sales = sales.filter(s => new Date(s.createdAt) <= new Date(toDate));
            
            reportData = sales;
            
            let html = '<table><thead><tr><th>Date</th><th>Invoice No</th><th>Customer</th><th>Items</th><th>Total</th><th>Status</th></tr></thead><tbody>';
            let total = 0;
            
            sales.forEach(sale => {
                html += `<tr>
                    <td>${new Date(sale.createdAt).toLocaleDateString()}</td>
                    <td>${sale.invoiceNo}</td>
                    <td>Customer #${sale.customerId}</td>
                    <td>${JSON.parse(sale.items || '[]').length}</td>
                    <td>$${sale.total.toFixed(2)}</td>
                    <td>${sale.paymentStatus}</td>
                </tr>`;
                total += sale.total;
            });
            
            html += `<tr class="summary-row"><td colspan="4">TOTAL</td><td>$${total.toFixed(2)}</td><td></td></tr></tbody></table>`;
            document.getElementById('reportOutput').innerHTML = html;
        }

        async function generate_purchase_report(fromDate, toDate) {
            const response = await fetch('/api/purchases', { headers: { 'Authorization': `Bearer ${token}` } });
            const result = await response.json();
            let purchases = result.data || [];
            
            if (fromDate) purchases = purchases.filter(p => new Date(p.createdAt) >= new Date(fromDate));
            if (toDate) purchases = purchases.filter(p => new Date(p.createdAt) <= new Date(toDate));
            
            reportData = purchases;
            
            let html = '<table><thead><tr><th>Date</th><th>PO Number</th><th>Supplier</th><th>Items</th><th>Total</th><th>Status</th></tr></thead><tbody>';
            let total = 0;
            
            purchases.forEach(purchase => {
                html += `<tr>
                    <td>${new Date(purchase.createdAt).toLocaleDateString()}</td>
                    <td>${purchase.purchaseNo}</td>
                    <td>Supplier #${purchase.supplierId}</td>
                    <td>${JSON.parse(purchase.items || '[]').length}</td>
                    <td>$${purchase.total.toFixed(2)}</td>
                    <td>${purchase.paymentStatus}</td>
                </tr>`;
                total += purchase.total;
            });
            
            html += `<tr class="summary-row"><td colspan="4">TOTAL</td><td>$${total.toFixed(2)}</td><td></td></tr></tbody></table>`;
            document.getElementById('reportOutput').innerHTML = html;
        }

        async function generate_stock_report() {
            const response = await fetch('/api/products', { headers: { 'Authorization': `Bearer ${token}` } });
            const result = await response.json();
            const products = result.data || [];
            
            reportData = products;
            
            let html = '<table><thead><tr><th>Product Name</th><th>SKU</th><th>Category</th><th>Stock</th><th>Cost</th><th>Price</th><th>Value</th></tr></thead><tbody>';
            let totalValue = 0;
            
            products.forEach(product => {
                const value = product.stock * product.cost;
                totalValue += value;
                html += `<tr>
                    <td><strong>${product.name}</strong></td>
                    <td>${product.sku}</td>
                    <td>${product.category}</td>
                    <td>${product.stock}</td>
                    <td>$${product.cost.toFixed(2)}</td>
                    <td>$${product.price.toFixed(2)}</td>
                    <td>$${value.toFixed(2)}</td>
                </tr>`;
            });
            
            html += `<tr class="summary-row"><td colspan="6">TOTAL STOCK VALUE</td><td>$${totalValue.toFixed(2)}</td></tr></tbody></table>`;
            document.getElementById('reportOutput').innerHTML = html;
        }

        async function generate_profit_loss_report(fromDate, toDate) {
            const [salesRes, purchasesRes, expensesRes] = await Promise.all([
                fetch('/api/sales', { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch('/api/purchases', { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch('/api/expenses', { headers: { 'Authorization': `Bearer ${token}` } })
            ]);
            
            let sales = (await salesRes.json()).data || [];
            let purchases = (await purchasesRes.json()).data || [];
            let expenses = (await expensesRes.json()).data || [];
            
            if (fromDate) {
                sales = sales.filter(s => new Date(s.createdAt) >= new Date(fromDate));
                purchases = purchases.filter(p => new Date(p.createdAt) >= new Date(fromDate));
                expenses = expenses.filter(e => new Date(e.createdAt) >= new Date(fromDate));
            }
            if (toDate) {
                sales = sales.filter(s => new Date(s.createdAt) <= new Date(toDate));
                purchases = purchases.filter(p => new Date(p.createdAt) <= new Date(toDate));
                expenses = expenses.filter(e => new Date(e.createdAt) <= new Date(toDate));
            }
            
            const totalSales = sales.reduce((sum, s) => sum + s.total, 0);
            const totalPurchases = purchases.reduce((sum, p) => sum + p.total, 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            const grossProfit = totalSales - totalPurchases;
            const netProfit = grossProfit - totalExpenses;
            
            reportData = [{ totalSales, totalPurchases, totalExpenses, grossProfit, netProfit }];
            
            let html = `
                <table>
                    <tbody>
                        <tr class="summary-row"><td colspan="2"><strong>REVENUE</strong></td></tr>
                        <tr><td>Total Sales</td><td style="text-align: right;">$${totalSales.toFixed(2)}</td></tr>
                        <tr class="summary-row"><td colspan="2"><strong>COST OF GOODS SOLD</strong></td></tr>
                        <tr><td>Total Purchases</td><td style="text-align: right;">$${totalPurchases.toFixed(2)}</td></tr>
                        <tr class="summary-row"><td><strong>GROSS PROFIT</strong></td><td style="text-align: right; color: ${grossProfit >= 0 ? '#10b981' : '#ef4444'};">$${grossProfit.toFixed(2)}</td></tr>
                        <tr class="summary-row"><td colspan="2"><strong>OPERATING EXPENSES</strong></td></tr>
                        <tr><td>Total Expenses</td><td style="text-align: right;">$${totalExpenses.toFixed(2)}</td></tr>
                        <tr class="summary-row"><td><strong>NET PROFIT</strong></td><td style="text-align: right; font-size: 20px; color: ${netProfit >= 0 ? '#10b981' : '#ef4444'};">$${netProfit.toFixed(2)}</td></tr>
                    </tbody>
                </table>
            `;
            document.getElementById('reportOutput').innerHTML = html;
        }

        async function generate_expense_report(fromDate, toDate) {
            const response = await fetch('/api/expenses', { headers: { 'Authorization': `Bearer ${token}` } });
            let expenses = (await response.json()).data || [];
            
            if (fromDate) expenses = expenses.filter(e => new Date(e.createdAt) >= new Date(fromDate));
            if (toDate) expenses = expenses.filter(e => new Date(e.createdAt) <= new Date(toDate));
            
            reportData = expenses;
            
            let html = '<table><thead><tr><th>Date</th><th>Category</th><th>Amount</th><th>Payment Method</th><th>Description</th></tr></thead><tbody>';
            let total = 0;
            
            expenses.forEach(expense => {
                html += `<tr>
                    <td>${new Date(expense.createdAt).toLocaleDateString()}</td>
                    <td>${expense.category}</td>
                    <td>$${expense.amount.toFixed(2)}</td>
                    <td>${expense.paymentMethod}</td>
                    <td>${expense.description || '-'}</td>
                </tr>`;
                total += expense.amount;
            });
            
            html += `<tr class="summary-row"><td colspan="2">TOTAL</td><td>$${total.toFixed(2)}</td><td colspan="2"></td></tr></tbody></table>`;
            document.getElementById('reportOutput').innerHTML = html;
        }

        // === PRODUCT-WISE SALES REPORT ===
        async function generate_product_sales_report(fromDate, toDate) {
            const response = await fetch('/api/sales', { headers: { 'Authorization': `Bearer ${token}` } });
            const result = await response.json();
            let sales = result.data || [];
            
            if (fromDate) sales = sales.filter(s => new Date(s.createdAt) >= new Date(fromDate));
            if (toDate) sales = sales.filter(s => new Date(s.createdAt) <= new Date(toDate));
            
            // Aggregate by product
            const productSales = {};
            sales.forEach(sale => {
                try {
                    const items = typeof sale.items === 'string' ? JSON.parse(sale.items) : sale.items;
                    items.forEach(item => {
                        const key = item.productName || 'Unknown Product';
                        if (!productSales[key]) {
                            productSales[key] = { name: key, quantity: 0, revenue: 0, count: 0 };
                        }
                        productSales[key].quantity += parseFloat(item.qty || item.quantity || 0);
                        productSales[key].revenue += parseFloat(item.amount || (item.price * item.qty) || 0);
                        productSales[key].count++;
                    });
                } catch (e) {}
            });
            
            reportData = Object.values(productSales);
            let html = '<table><thead><tr><th>Product</th><th>Qty Sold</th><th>Orders</th><th>Revenue (Rs.)</th><th>Avg per Sale (Rs.)</th></tr></thead><tbody>';
            let totalQty = 0, totalRevenue = 0;
            
            Object.values(productSales).forEach(prod => {
                const avg = prod.count > 0 ? prod.revenue / prod.count : 0;
                html += `<tr>
                    <td><strong>${prod.name}</strong></td>
                    <td>${prod.quantity.toFixed(2)}</td>
                    <td>${prod.count}</td>
                    <td>Rs. ${prod.revenue.toLocaleString('en-PK', {minimumFractionDigits: 2})}</td>
                    <td>Rs. ${avg.toLocaleString('en-PK', {minimumFractionDigits: 2})}</td>
                </tr>`;
                totalQty += prod.quantity;
                totalRevenue += prod.revenue;
            });
            
            html += `<tr class="summary-row"><td><strong>TOTAL</strong></td><td><strong>${totalQty.toFixed(2)}</strong></td><td>-</td><td><strong>Rs. ${totalRevenue.toLocaleString('en-PK', {minimumFractionDigits: 2})}</strong></td><td>-</td></tr></tbody></table>`;
            document.getElementById('reportOutput').innerHTML = html;
        }

        // === PAYABLES & RECEIVABLES REPORT ===
        async function generate_payables_receivables_report(fromDate, toDate) {
            const [salesRes, purchasesRes] = await Promise.all([
                fetch('/api/sales', { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch('/api/purchases', { headers: { 'Authorization': `Bearer ${token}` } })
            ]);
            
            const sales = (await salesRes.json()).data || [];
            const purchases = (await purchasesRes.json()).data || [];
            
            let totalReceivable = 0, totalPayable = 0;
            const receivables = [], payables = [];
            
            sales.forEach(sale => {
                if (sale.paymentStatus !== 'paid') {
                    const due = parseFloat(sale.total || 0);
                    totalReceivable += due;
                    receivables.push({
                        type: 'Receivable',
                        refNo: sale.invoiceNo,
                        party: 'Customer',
                        amount: due,
                        status: sale.paymentStatus
                    });
                }
            });
            
            purchases.forEach(purchase => {
                if (purchase.paymentStatus !== 'paid') {
                    const due = parseFloat(purchase.total || 0);
                    totalPayable += due;
                    payables.push({
                        type: 'Payable',
                        refNo: purchase.purchaseNo,
                        party: 'Supplier',
                        amount: due,
                        status: purchase.paymentStatus
                    });
                }
            });
            
            reportData = [...receivables, ...payables];
            let html = '<h3 style="color: #059669; margin-bottom: 20px;">üí∞ Receivables (Money to Receive)</h3>';
            html += '<table><thead><tr><th>Ref No</th><th>Party</th><th>Amount (Rs.)</th><th>Status</th></tr></thead><tbody>';
            
            receivables.forEach(r => {
                html += `<tr><td>${r.refNo}</td><td>${r.party}</td><td>Rs. ${r.amount.toLocaleString('en-PK', {minimumFractionDigits: 2})}</td><td>${r.status}</td></tr>`;
            });
            html += `<tr class="summary-row"><td colspan="2"><strong>TOTAL RECEIVABLES</strong></td><td colspan="2"><strong>Rs. ${totalReceivable.toLocaleString('en-PK', {minimumFractionDigits: 2})}</strong></td></tr></tbody></table>`;
            
            html += '<h3 style="color: #dc2626; margin: 30px 0 20px;">üí≥ Payables (Money to Pay)</h3>';
            html += '<table><thead><tr><th>Ref No</th><th>Party</th><th>Amount (Rs.)</th><th>Status</th></tr></thead><tbody>';
            
            payables.forEach(p => {
                html += `<tr><td>${p.refNo}</td><td>${p.party}</td><td>Rs. ${p.amount.toLocaleString('en-PK', {minimumFractionDigits: 2})}</td><td>${p.status}</td></tr>`;
            });
            html += `<tr class="summary-row"><td colspan="2"><strong>TOTAL PAYABLES</strong></td><td colspan="2"><strong>Rs. ${totalPayable.toLocaleString('en-PK', {minimumFractionDigits: 2})}</strong></td></tr></tbody></table>`;
            
            html += `<div style="margin-top: 30px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                <h3>Net Position</h3>
                <p style="font-size: 18px; margin-top: 10px;"><strong>Receivables - Payables = Rs. ${(totalReceivable - totalPayable).toLocaleString('en-PK', {minimumFractionDigits: 2})}</strong></p>
            </div>`;
            
            document.getElementById('reportOutput').innerHTML = html;
        }

        // === CASH FLOW REPORT ===
        async function generate_cash_flow_report(fromDate, toDate) {
            const [salesRes, purchasesRes, expensesRes, paymentsRes] = await Promise.all([
                fetch('/api/sales', { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch('/api/purchases', { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch('/api/expenses', { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch('/api/payments', { headers: { 'Authorization': `Bearer ${token}` } })
            ]);
            
            let sales = (await salesRes.json()).data || [];
            let purchases = (await purchasesRes.json()).data || [];
            let expenses = (await expensesRes.json()).data || [];
            let payments = (await paymentsRes.json()).data || [];
            
            if (fromDate) {
                sales = sales.filter(s => new Date(s.createdAt) >= new Date(fromDate));
                purchases = purchases.filter(p => new Date(p.createdAt) >= new Date(fromDate));
                expenses = expenses.filter(e => new Date(e.date) >= new Date(fromDate));
                payments = payments.filter(p => new Date(p.date) >= new Date(fromDate));
            }
            if (toDate) {
                sales = sales.filter(s => new Date(s.createdAt) <= new Date(toDate));
                purchases = purchases.filter(p => new Date(p.createdAt) <= new Date(toDate));
                expenses = expenses.filter(e => new Date(e.date) <= new Date(toDate));
                payments = payments.filter(p => new Date(p.date) <= new Date(toDate));
            }
            
            const cashIn = sales.reduce((sum, s) => sum + parseFloat(s.total || 0), 0) +
                          payments.filter(p => p.type === 'received').reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
            
            const cashOut = purchases.reduce((sum, p) => sum + parseFloat(p.total || 0), 0) +
                           expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0) +
                           payments.filter(p => p.type === 'paid').reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
            
            const netCashFlow = cashIn - cashOut;
            
            reportData = [{cashIn, cashOut, netCashFlow}];
            
            let html = '<table><thead><tr><th>Category</th><th>Amount (Rs.)</th></tr></thead><tbody>';
            html += `<tr style="background: #d1fae5;"><td><strong>üí∞ CASH INFLOWS</strong></td><td><strong>Rs. ${cashIn.toLocaleString('en-PK', {minimumFractionDigits: 2})}</strong></td></tr>`;
            html += `<tr><td style="padding-left: 30px;">Sales Revenue</td><td>Rs. ${sales.reduce((sum, s) => sum + parseFloat(s.total || 0), 0).toLocaleString('en-PK', {minimumFractionDigits: 2})}</td></tr>`;
            html += `<tr><td style="padding-left: 30px;">Payments Received</td><td>Rs. ${payments.filter(p => p.type === 'received').reduce((sum, p) => sum + parseFloat(p.amount || 0), 0).toLocaleString('en-PK', {minimumFractionDigits: 2})}</td></tr>`;
            
            html += `<tr style="background: #fee2e2;"><td><strong>üí∏ CASH OUTFLOWS</strong></td><td><strong>Rs. ${cashOut.toLocaleString('en-PK', {minimumFractionDigits: 2})}</strong></td></tr>`;
            html += `<tr><td style="padding-left: 30px;">Purchase Payments</td><td>Rs. ${purchases.reduce((sum, p) => sum + parseFloat(p.total || 0), 0).toLocaleString('en-PK', {minimumFractionDigits: 2})}</td></tr>`;
            html += `<tr><td style="padding-left: 30px;">Expenses</td><td>Rs. ${expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0).toLocaleString('en-PK', {minimumFractionDigits: 2})}</td></tr>`;
            html += `<tr><td style="padding-left: 30px;">Payments Made</td><td>Rs. ${payments.filter(p => p.type === 'paid').reduce((sum, p) => sum + parseFloat(p.amount || 0), 0).toLocaleString('en-PK', {minimumFractionDigits: 2})}</td></tr>`;
            
            html += `<tr class="summary-row" style="background: ${netCashFlow >= 0 ? '#d1fae5' : '#fee2e2'};"><td><strong>‚úÖ NET CASH FLOW</strong></td><td><strong>Rs. ${netCashFlow.toLocaleString('en-PK', {minimumFractionDigits: 2})}</strong></td></tr>`;
            html += '</tbody></table>';
            
            document.getElementById('reportOutput').innerHTML = html;
        }

        // === BALANCE SHEET REPORT ===
        async function generate_balance_sheet_report(fromDate, toDate) {
            const [salesRes, purchasesRes, productsRes, bankRes] = await Promise.all([
                fetch('/api/sales', { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch('/api/purchases', { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch('/api/products', { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch('/api/bank-accounts', { headers: { 'Authorization': `Bearer ${token}` } })
            ]);
            
            const sales = (await salesRes.json()).data || [];
            const purchases = (await purchasesRes.json()).data || [];
            const products = (await productsRes.json()).data || [];
            const banks = (await bankRes.json()).data || [];
            
            // Calculate Assets
            const cashInBank = banks.reduce((sum, b) => sum + parseFloat(b.balance || 0), 0);
            const stockValue = products.reduce((sum, p) => sum + (parseFloat(p.cost || 0) * parseInt(p.stock || 0)), 0);
            const receivables = sales.filter(s => s.paymentStatus !== 'paid').reduce((sum, s) => sum + parseFloat(s.total || 0), 0);
            const totalAssets = cashInBank + stockValue + receivables;
            
            // Calculate Liabilities
            const payables = purchases.filter(p => p.paymentStatus !== 'paid').reduce((sum, p) => sum + parseFloat(p.total || 0), 0);
            
            // Calculate Equity
            const equity = totalAssets - payables;
            
            reportData = [{cashInBank, stockValue, receivables, totalAssets, payables, equity}];
            
            let html = '<table><thead><tr><th colspan="2" style="background: #3b82f6; color: white; font-size: 18px;">BALANCE SHEET</th></tr></thead><tbody>';
            
            html += `<tr style="background: #dbeafe;"><td colspan="2"><strong>üè¶ ASSETS</strong></td></tr>`;
            html += `<tr><td style="padding-left: 30px;">Cash in Bank</td><td>Rs. ${cashInBank.toLocaleString('en-PK', {minimumFractionDigits: 2})}</td></tr>`;
            html += `<tr><td style="padding-left: 30px;">Stock/Inventory</td><td>Rs. ${stockValue.toLocaleString('en-PK', {minimumFractionDigits: 2})}</td></tr>`;
            html += `<tr><td style="padding-left: 30px;">Accounts Receivable</td><td>Rs. ${receivables.toLocaleString('en-PK', {minimumFractionDigits: 2})}</td></tr>`;
            html += `<tr style="background: #93c5fd;"><td><strong>TOTAL ASSETS</strong></td><td><strong>Rs. ${totalAssets.toLocaleString('en-PK', {minimumFractionDigits: 2})}</strong></td></tr>`;
            
            html += `<tr style="background: #fee2e2;"><td colspan="2"><strong>üí≥ LIABILITIES</strong></td></tr>`;
            html += `<tr><td style="padding-left: 30px;">Accounts Payable</td><td>Rs. ${payables.toLocaleString('en-PK', {minimumFractionDigits: 2})}</td></tr>`;
            html += `<tr style="background: #fca5a5;"><td><strong>TOTAL LIABILITIES</strong></td><td><strong>Rs. ${payables.toLocaleString('en-PK', {minimumFractionDigits: 2})}</strong></td></tr>`;
            
            html += `<tr style="background: #d1fae5;"><td colspan="2"><strong>üí∞ EQUITY</strong></td></tr>`;
            html += `<tr style="background: #6ee7b7;"><td><strong>Owner's Equity (Assets - Liabilities)</strong></td><td><strong>Rs. ${equity.toLocaleString('en-PK', {minimumFractionDigits: 2})}</strong></td></tr>`;
            
            html += '</tbody></table>';
            html += `<div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                <p style="font-size: 14px; color: #6b7280;"><strong>Accounting Equation:</strong> Assets = Liabilities + Equity</p>
                <p style="font-size: 14px; color: #6b7280; margin-top: 5px;">Rs. ${totalAssets.toLocaleString('en-PK', {minimumFractionDigits: 2})} = Rs. ${payables.toLocaleString('en-PK', {minimumFractionDigits: 2})} + Rs. ${equity.toLocaleString('en-PK', {minimumFractionDigits: 2})}</p>
            </div>`;
            
            document.getElementById('reportOutput').innerHTML = html;
        }

        // === CUSTOMER-WISE SALES REPORT ===
        async function generate_customer_sales_report(fromDate, toDate) {
            await generate_sales_report(fromDate, toDate);
        }

        // === CASH REPORT ===
        async function generate_cash_report(fromDate, toDate) {
            const paymentsRes = await fetch('/api/payments', { headers: { 'Authorization': `Bearer ${token}` } });
            let payments = (await paymentsRes.json()).data || [];
            
            if (fromDate) payments = payments.filter(p => new Date(p.date) >= new Date(fromDate));
            if (toDate) payments = payments.filter(p => new Date(p.date) <= new Date(toDate));
            
            const cashPayments = payments.filter(p => p.paymentMethod === 'cash');
            reportData = cashPayments;
            
            let html = '<table><thead><tr><th>Date</th><th>Type</th><th>Reference</th><th>Amount (Rs.)</th><th>Notes</th></tr></thead><tbody>';
            let cashIn = 0, cashOut = 0;
            
            cashPayments.forEach(payment => {
                const amount = parseFloat(payment.amount || 0);
                if (payment.type === 'received') cashIn += amount;
                else cashOut += amount;
                
                html += `<tr>
                    <td>${new Date(payment.date).toLocaleDateString('en-PK')}</td>
                    <td><span style="color: ${payment.type === 'received' ? '#059669' : '#dc2626'};">${payment.type === 'received' ? 'üí∞ Received' : 'üí∏ Paid'}</span></td>
                    <td>${payment.referenceNo || '-'}</td>
                    <td>Rs. ${amount.toLocaleString('en-PK', {minimumFractionDigits: 2})}</td>
                    <td>${payment.notes || '-'}</td>
                </tr>`;
            });
            
            const balance = cashIn - cashOut;
            html += `<tr class="summary-row"><td colspan="3"><strong>CASH IN HAND</strong></td><td colspan="2"><strong>Rs. ${balance.toLocaleString('en-PK', {minimumFractionDigits: 2})}</strong></td></tr>`;
            html += '</tbody></table>';
            
            document.getElementById('reportOutput').innerHTML = html;
        }

        // === BANK ACCOUNT REPORT ===
        async function generate_bank_report(fromDate, toDate) {
            const response = await fetch('/api/bank-accounts', { headers: { 'Authorization': `Bearer ${token}` } });
            const accounts = (await response.json()).data || [];
            reportData = accounts;
            
            let html = '<table><thead><tr><th>Account Type</th><th>Name</th><th>Bank</th><th>Account No</th><th>Balance (Rs.)</th></tr></thead><tbody>';
            let total = 0;
            
            accounts.forEach(acc => {
                html += `<tr>
                    <td><strong>${acc.accountType}</strong></td>
                    <td>${acc.accountName}</td>
                    <td>${acc.bankName || '-'}</td>
                    <td>${acc.accountNumber || '-'}</td>
                    <td>Rs. ${parseFloat(acc.balance || 0).toLocaleString('en-PK', {minimumFractionDigits: 2})}</td>
                </tr>`;
                total += parseFloat(acc.balance || 0);
            });
            
            html += `<tr class="summary-row"><td colspan="4"><strong>TOTAL BANK BALANCE</strong></td><td><strong>Rs. ${total.toLocaleString('en-PK', {minimumFractionDigits: 2})}</strong></td></tr></tbody></table>`;
            document.getElementById('reportOutput').innerHTML = html;
        }

        function exportToCSV() {
            if (reportData.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = Object.keys(reportData[0]);
            const csv = [
                headers.join(','),
                ...reportData.map(row => headers.map(h => JSON.stringify(row[h] || '')).join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentReport}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('Report exported to CSV!');
        }
    </script>
</body>
</html>

