<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payments - Zaviyar Chemicals</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e8edf2 100%); min-height: 100vh; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 24px 40px; box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; animation: fadeIn 0.5s ease-out; }
        .header h1 { color: white; font-size: 28px; font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: center; gap: 12px; }
        .header h1::before { content: 'ðŸ’µ'; font-size: 32px; }
        .header-actions { display: flex; gap: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .container { padding: 0 30px 30px; max-width: 1400px; margin: 0 auto; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .tab.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .search-bar { margin-bottom: 20px; display: flex; gap: 15px; }
        .search-bar input { flex: 1; padding: 12px 16px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; }
        th { padding: 12px; text-align: left; font-size: 12px; font-weight: 700; text-transform: uppercase; color: #6b7280; border-bottom: 2px solid #e5e7eb; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; color: #1f2937; }
        tr:hover { background: #f9fafb; }
        .badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #1f2937; font-size: 20px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px; color: #1f2937; font-weight: 600; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        .empty-state { text-align: center; padding: 60px 20px; color: #6b7280; }
        
        /* RESPONSIVE DESIGN */
        @media (max-width: 1024px) { .modal-content { max-width: 700px; padding: 25px; } .form-row { gap: 12px; } }
        @media (max-width: 768px) { .modal-content { max-width: 95%; width: 95%; padding: 20px; margin: 10px; max-height: 90vh; } .modal-header h2 { font-size: 18px; } .close-btn { font-size: 28px; } .form-row { grid-template-columns: 1fr; gap: 10px; } .form-group { margin-bottom: 16px; } .form-group label { font-size: 13px; margin-bottom: 6px; } .form-group input, .form-group select, .form-group textarea { padding: 10px 14px; font-size: 14px; } .btn { padding: 12px 18px; font-size: 13px; } .header { padding: 18px 20px; flex-direction: column; gap: 12px; align-items: flex-start; } .header h1 { font-size: 22px; } .header-actions { width: 100%; flex-direction: column; gap: 10px; } .header-actions .btn { width: 100%; } .container { padding: 0 15px 15px; } }
        @media (max-width: 480px) { .modal-content { width: 100%; height: 100%; max-height: 100vh; max-width: 100%; border-radius: 0; padding: 15px; margin: 0; } .modal-header { margin-bottom: 15px; padding-bottom: 12px; border-bottom: 2px solid #e5e7eb; } .modal-header h2 { font-size: 16px; } .close-btn { font-size: 32px; padding: 0; min-width: 32px; } .form-group { margin-bottom: 14px; } .form-group label { font-size: 12px; margin-bottom: 6px; } .form-group input, .form-group select, .form-group textarea { padding: 10px 12px; font-size: 13px; } .btn { padding: 10px 16px; font-size: 13px; } .header { padding: 15px; } .header h1 { font-size: 18px; } .header h1::before { font-size: 24px; } .container { padding: 0 10px 10px; } .card { padding: 15px; border-radius: 8px; } table { font-size: 12px; } th, td { padding: 8px 6px; } th { font-size: 10px; } }
        @media (max-width: 360px) { .modal-content { padding: 12px; } .modal-header h2 { font-size: 15px; } .form-group label { font-size: 11px; } .form-group input, .form-group select, .form-group textarea { padding: 8px 10px; font-size: 12px; } .btn { padding: 8px 14px; font-size: 12px; } .header h1 { font-size: 16px; } table { font-size: 11px; } th, td { padding: 6px 4px; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>Payments Management</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="window.location.href='/dashboard.html'">Back to Dashboard</button>
            <button class="btn btn-success" onclick="openReceivedModal()">+ Payment Received</button>
            <button class="btn btn-danger" onclick="openPaidModal()">+ Payment Paid</button>
            <button class="btn btn-warning" onclick="openJournalModal()">+ Journal Voucher</button>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('all')">All Payments</div>
            <div class="tab" onclick="switchTab('received')">Received</div>
            <div class="tab" onclick="switchTab('paid')">Paid</div>
            <div class="tab" onclick="switchTab('journal')">Journal</div>
        </div>

        <div class="card">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search payments..." onkeyup="searchPayments()">
                <input type="date" id="fromDate" onchange="searchPayments()">
                <input type="date" id="toDate" onchange="searchPayments()">
            </div>

            <div id="paymentsList">
                <div class="loading">Loading payments...</div>
            </div>
        </div>
    </div>

    <!-- Payment Received Modal -->
    <div id="receivedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Payment Received</h2>
                <button class="close-btn" onclick="closeModals()">&times;</button>
            </div>
            <form onsubmit="savePayment(event, 'received')">
                <div class="form-group">
                    <label>Customer *</label>
                    <select id="receivedCustomer" required></select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount *</label>
                        <input type="number" id="receivedAmount" step="0.01" required min="0">
                    </div>
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="receivedDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Payment Method *</label>
                    <select id="receivedMethod" required>
                        <option value="cash">Cash</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="cheque">Cheque</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reference</label>
                    <input type="text" id="receivedRef">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="receivedNotes" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModals()">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Payment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Paid Modal -->
    <div id="paidModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Payment Paid</h2>
                <button class="close-btn" onclick="closeModals()">&times;</button>
            </div>
            <form onsubmit="savePayment(event, 'paid')">
                <div class="form-group">
                    <label>Supplier *</label>
                    <select id="paidSupplier" required></select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount *</label>
                        <input type="number" id="paidAmount" step="0.01" required min="0">
                    </div>
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="paidDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Payment Method *</label>
                    <select id="paidMethod" required>
                        <option value="cash">Cash</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="cheque">Cheque</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reference</label>
                    <input type="text" id="paidRef">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="paidNotes" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModals()">Cancel</button>
                    <button type="submit" class="btn btn-danger">Save Payment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Journal Voucher Modal -->
    <div id="journalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Journal Voucher</h2>
                <button class="close-btn" onclick="closeModals()">&times;</button>
            </div>
            <form onsubmit="savePayment(event, 'journal')">
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount *</label>
                        <input type="number" id="journalAmount" step="0.01" required min="0">
                    </div>
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="journalDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Type *</label>
                    <select id="journalType" required>
                        <option value="adjustment">Adjustment</option>
                        <option value="transfer">Transfer</option>
                        <option value="correction">Correction</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reference *</label>
                    <input type="text" id="journalRef" required>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="journalNotes" rows="3" required></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModals()">Cancel</button>
                    <button type="submit" class="btn btn-warning">Save Voucher</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';

        let payments = [];
        let customers = [];
        let suppliers = [];
        let currentFilter = 'all';

        init();

        async function init() {
            await loadCustomers();
            await loadSuppliers();
            await loadPayments();
        }

        async function loadCustomers() {
            try {
                const response = await fetch('/api/contacts?type=customer', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                customers = result.data || [];
                const select = document.getElementById('receivedCustomer');
                select.innerHTML = '<option value="">Select Customer</option>';
                customers.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                });
            } catch (error) {
                console.error('Failed to load customers');
            }
        }

        async function loadSuppliers() {
            try {
                const response = await fetch('/api/contacts?type=supplier', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                suppliers = result.data || [];
                const select = document.getElementById('paidSupplier');
                select.innerHTML = '<option value="">Select Supplier</option>';
                suppliers.forEach(s => {
                    select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                });
            } catch (error) {
                console.error('Failed to load suppliers');
            }
        }

        async function loadPayments() {
            try {
                const response = await fetch('/api/payments', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to load');
                const result = await response.json();
                payments = result.data || [];
                displayPayments(payments);
            } catch (error) {
                document.getElementById('paymentsList').innerHTML = '<div class="error">Failed to load payments</div>';
            }
        }

        function switchTab(filter) {
            currentFilter = filter;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            const filtered = filter === 'all' ? payments : payments.filter(p => p.type === filter);
            displayPayments(filtered);
        }

        function displayPayments(paymentsToShow) {
            const container = document.getElementById('paymentsList');
            if (paymentsToShow.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No payments found</h3></div>';
                return;
            }

            let html = '<table><thead><tr><th>Date</th><th>Type</th><th>Party</th><th>Amount</th><th>Method</th><th>Reference</th><th>Actions</th></tr></thead><tbody>';
            paymentsToShow.forEach(payment => {
                const date = new Date(payment.date || payment.createdAt).toLocaleDateString();
                const typeBadge = payment.type === 'received' ? 'success' : payment.type === 'paid' ? 'danger' : 'warning';
                const party = payment.contactId ? (customers.find(c => c.id === payment.contactId) || suppliers.find(s => s.id === payment.contactId) || {name: 'Unknown'}).name : '-';
                
                html += `<tr>
                    <td>${date}</td>
                    <td><span class="badge badge-${typeBadge}">${payment.type.toUpperCase()}</span></td>
                    <td>${party}</td>
                    <td><strong>$${payment.amount.toFixed(2)}</strong></td>
                    <td>${payment.paymentMethod || '-'}</td>
                    <td>${payment.reference || '-'}</td>
                    <td><button class="btn btn-danger" onclick="deletePayment(${payment.id})">Delete</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function searchPayments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;

            let filtered = payments.filter(payment => {
                const matchesFilter = currentFilter === 'all' || payment.type === currentFilter;
                const matchesSearch = (payment.reference || '').toLowerCase().includes(searchTerm);
                let matchesDate = true;
                if (fromDate || toDate) {
                    const paymentDate = new Date(payment.date || payment.createdAt);
                    if (fromDate) matchesDate = matchesDate && paymentDate >= new Date(fromDate);
                    if (toDate) matchesDate = matchesDate && paymentDate <= new Date(toDate);
                }
                return matchesFilter && matchesSearch && matchesDate;
            });
            displayPayments(filtered);
        }

        function openReceivedModal() {
            document.getElementById('receivedDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('receivedModal').classList.add('active');
        }

        function openPaidModal() {
            document.getElementById('paidDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paidModal').classList.add('active');
        }

        function openJournalModal() {
            document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('journalModal').classList.add('active');
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }

        async function savePayment(event, type) {
            event.preventDefault();
            let data = { type };

            if (type === 'received') {
                data.contactId = parseInt(document.getElementById('receivedCustomer').value);
                data.amount = parseFloat(document.getElementById('receivedAmount').value);
                data.date = document.getElementById('receivedDate').value;
                data.paymentMethod = document.getElementById('receivedMethod').value;
                data.reference = document.getElementById('receivedRef').value;
                data.notes = document.getElementById('receivedNotes').value;
            } else if (type === 'paid') {
                data.contactId = parseInt(document.getElementById('paidSupplier').value);
                data.amount = parseFloat(document.getElementById('paidAmount').value);
                data.date = document.getElementById('paidDate').value;
                data.paymentMethod = document.getElementById('paidMethod').value;
                data.reference = document.getElementById('paidRef').value;
                data.notes = document.getElementById('paidNotes').value;
            } else {
                data.amount = parseFloat(document.getElementById('journalAmount').value);
                data.date = document.getElementById('journalDate').value;
                data.paymentMethod = document.getElementById('journalType').value;
                data.reference = document.getElementById('journalRef').value;
                data.notes = document.getElementById('journalNotes').value;
            }

            try {
                const response = await fetch('/api/payments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error('Failed to save');
                closeModals();
                loadPayments();
                alert('Payment saved!');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deletePayment(id) {
            if (!confirm('Delete this payment?')) return;
            try {
                const response = await fetch(`/api/payments/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to delete');
                loadPayments();
                alert('Payment deleted!');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    </script>
</body>
</html>

